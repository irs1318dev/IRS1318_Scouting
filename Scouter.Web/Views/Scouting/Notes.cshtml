@model Scouter.Web.ViewModels.ScoutViewModel

@{
    ViewBag.Title = "Notes";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section scripts{
	<script>
		$(function ()
		{
			var Scout = function()
			{
				this.color = ko.observable(@Model.Color);
				this.matchID = ko.observable(@Model.Match.Id);
				this.matchNumber = ko.observable(@Model.Match.SequenceNumber);
				this.teamID = ko.observable(@Model.Team.Id);
				this.teamName = ko.observable("@Model.Team.Name");
				this.teamNumber = ko.observable(@Model.Team.Number);
				this.scoutID = ko.observable(@Model.Scouter_Id);
			}
			var ScoutInfo = function ()
			{
				this.scouter = 0;
				this.match_Id = 0;
				this.scouterStatus = 0;
				this.team_Id = 0;
			}
			var ScoutNotes = function ()
			{
				this.Notes = vm.notes();
				this.Team_Id = vm.model.teamID;
				this.Match_Id = vm.model.matchID;
				this.Mode = 0;
			}

            //
            // CLIENT SIDE VIEWMODEL
            //
            var ViewModel = function (scout)
            {
            	this.model = scout;
            	this.errorMessage = ko.observable("Waiting for next Match... If you believe that you should have advance, notify the lead scout that you are infact ready to advance. Then wait for further instructions.");

            	this.disabledClicked = ko.observable(false);
            	this.ballStuckClicked = ko.observable(false);
            	this.lowPowerShotClicked = ko.observable(false);
            	this.reliableShooterClicked = ko.observable(false);
            	this.badCollectorClicked = ko.observable(false);

            	this.showWait = ko.observable(false);

            	this.notes = ko.observable("");

            	this.disabled = function()
            	{
            		this.disabledClicked(!this.disabledClicked());
            		this.setNotes();
            	}
            	this.ballStuck = function ()
            	{
            		this.ballStuckClicked(!this.ballStuckClicked());
            		this.setNotes();
            	}
            	this.lowPowerShot = function ()
            	{
            		this.lowPowerShotClicked(!this.lowPowerShotClicked());
            		this.setNotes();
            	}
            	this.reliableShooter = function ()
            	{
            		this.reliableShooterClicked(!this.reliableShooterClicked());
            		this.setNotes();
            	}
            	this.badCollector = function ()
            	{
            		this.badCollectorClicked(!this.badCollectorClicked());
            		this.setNotes();
            	}

            	this.setNotes = function()
            	{
            		this.notes("");
					if(this.disabledClicked())
						this.notes("Robot was disabled during the match. ");
            		if (this.ballStuckClicked())
            			this.notes(this.notes() + "A ball got stuck in the robot during the match. ");
            		if (this.lowPowerShotClicked())
            			this.notes(this.notes() + "low power shot? ");
            		if (this.reliableShooterClicked())
            			this.notes(this.notes() + "This robot had a reliable shooter. ");
            		if (this.badCollectorClicked())
            			this.notes(this.notes() + "This robot had a poor collector design. ");
            	}

            	this.nav = function()
            	{
            		var v = scouterDataService.getScoutData().done(function (data)
            		{
            			scouterDataService.addNotes(new ScoutNotes());
            			if (data.Match_ID == vm.model.matchID())
            			{

            				var d = new ScoutInfo();
            				d.scouter = vm.model.scoutID;
            				d.scouterStatus = 4;
            				d.match_Id = vm.model.matchID;

            				$('#row1').collapse('hide');
            				$('#row2').collapse('hide');
            				scouterDataService.updateScoutData(ko.toJS(d)).fail(function(error)
							{
								if (error.statusText)
								{
									vm.errorMessage(error.statusText);
								}

								if (error.responseText)
								{
									var
										msg = JSON.parse(error.responseText),
										keys = _.keys(msg),
										txt = '';

									_.each(keys, function (key)
									{
										txt += msg[key] + ' ';
									});
									vm.errorMessage(txt);
								}

								vm.errorMessage("Oops. something happened. Still waiting for a match, but the Scout Admin doesn't know.\n" + vm.errorMessage());
							});
            				vm.showWait(true);
            				setTimeout(vm.navigation, 1000);
            			}
            			else
            			{
            				document.location = '/scouting/Auto/@Model.Scouter_Id';
            			}
            		}).fail(function (error)
            		{
            			$('#row1').collapse('hide');
            			$('#row2').collapse('hide');

						
            			if (error.statusText)
            			{
            				vm.errorMessage(error.statusText);
            			}

            			if (error.responseText)
            			{
            				var
								msg = JSON.parse(error.responseText),
								keys = _.keys(msg),
								txt = '';

            				_.each(keys, function (key)
            				{
            					txt += msg[key] + ' ';
            				});
            				vm.errorMessage(txt);
            			}

            			vm.errorMessage("Oops. something happened.\n" + vm.errorMessage());

            			setTimeout(vm.navigation, 5000);
            		})
            	}

            	this.navigation = function()
            	{
            		var v = scouterDataService.getScoutData().done(function (data)
            		{
            			if (data.Match_ID != vm.model.matchID())
            			{
            				document.location = '/scouting/Auto/@Model.Scouter_Id';
            			}

            			setTimeout(vm.navigation, 1000);
            		}).fail(function (error)
            		{
            			$('#row1').collapse('hide');
            			$('#row2').collapse('hide');


            			if (error.statusText)
            			{
            				vm.errorMessage(error.statusText);
            			}

            			if (error.responseText)
            			{
            				var
								msg = JSON.parse(error.responseText),
								keys = _.keys(msg),
								txt = '';

            				_.each(keys, function (key)
            				{
            					txt += msg[key] + ' ';
            				});
            				vm.errorMessage(txt);
            			}

            			vm.errorMessage("Oops. something happened.\n" + vm.errorMessage());

            			setTimeout(vm.navigation, 5000);
            		})
            	}

            	if (this.model.scoutID() < 4)
            	{
            		this.color = 'red';
            		this.clickColor = 'lightpink';
            		this.colorAlt = '#FF4444';
            	}
            	else
            	{
            		this.color = 'deepskyblue';
            		this.clickColor = 'lightcyan';
            		this.colorAlt = 'skyblue';
            	}

            	var d = new ScoutInfo();
            	d.scouter = this.model.scoutID;
            	d.scouterStatus = 3;
            	d.match_Id = this.model.matchID;
            	d.team_Id = this.model.teamID;

				scouterDataService.updateScoutData(ko.toJS(d));
            }
            var vm = new ViewModel(new Scout());
            ko.applyBindings(vm);
        })
	</script>
}

<div class="row">
	Notes <span style="font-size:16px" data-bind="text: ' Match: ' + model.matchNumber() + ' Team: ' +model.teamNumber() + ' ('+ model.teamName() + ')'" />
</div>

<div class="row panel-collapse collapse in" id="row1">
	<div data-bind="click: disabled, style: {backgroundColor: disabledClicked() ? clickColor : color}" class="col-xs-2">
		<br />
		<br />
		<span>Disabled</span>
		<br />
		<br />
		<br />
	</div>
	<div data-bind="click: ballStuck, style: {backgroundColor: ballStuckClicked() ? clickColor : colorAlt}" class="col-xs-2">
		<br />
		<br />
		<span>Ball Stuck</span>
		<br />
		<br />
		<br />
	</div>
	<div data-bind="click: lowPowerShot, style: {backgroundColor: lowPowerShotClicked() ? clickColor : color}" class="col-xs-2">
		<br />
		<br />
		<span>Low Power Shot</span>
		<br />
		<br />
		<br />
	</div>
	<div data-bind="click: reliableShooter, style: {backgroundColor: reliableShooterClicked() ? clickColor : colorAlt}" class="col-xs-2">
		<br />
		<br />
		<span>Reliable Shooter</span>
		<br />
		<br />
		<br />
	</div>
	<div data-bind="click: badCollector, style: {backgroundColor: badCollectorClicked() ? clickColor : color}" class="col-xs-2">
		<br />
		<br />
		<span>Bad Collector</span>
		<br />
		<br />
		<br />
	</div>
	<div data-bind="style: {backgroundColor: colorAlt}" class="col-xs-2">
		<br />
		<br />
		<br/>
		<br />
		<br />
		<br />
	</div>
</div>
<div class="row panel-collapse collapse in" id="row2">
	<span data-bind="text: notes"></span>
</div>
<div class="row">
	<div data-bind="click: nav, style: {backgroundColor: colorAlt}" class="col-xs-2">
		<br />
		<br />
		<span>Next Match</span>
		<br />
		<br />
		<br />
	</div>
	<div id="error" data-bind="visible: showWait(), style: {backgroundColor: color}" class="col-xs-10">
		<br />
		<br />
		<span data-bind="text:errorMessage()"></span>
		<br />
		<br />
	</div>
</div>